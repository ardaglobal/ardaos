# ArdaOS Compliance Compiler Build System
# Build, test, and distribution automation for the compliance compiler tool

.DEFAULT_GOAL := help
.PHONY: help build test clean install proto deps build-all release docker lint fmt vet bench integration-test validate-examples update-schemas

# Build configuration
BINARY_NAME := compliance-compiler
MAIN_PACKAGE := ./cmd/compliance-compiler
BUILD_DIR := bin
COVERAGE_FILE := coverage.out
COVERAGE_HTML := coverage.html

# Version and build information
VERSION ?= $(shell git describe --tags --always --dirty)
BUILD_TIME := $(shell date -u +%Y-%m-%dT%H:%M:%SZ)
GIT_COMMIT := $(shell git rev-parse HEAD)
GIT_BRANCH := $(shell git rev-parse --abbrev-ref HEAD)

# Build flags
LDFLAGS := -ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME) -X main.gitCommit=$(GIT_COMMIT) -X main.gitBranch=$(GIT_BRANCH)"

# Go configuration
GO := go
GOFMT := gofmt
GOLINT := golangci-lint
GOVET := go vet
GOTEST := go test

# External tools
BUF := buf
PROTOC_GEN_GO := protoc-gen-go

# Docker configuration
DOCKER_IMAGE := ardaos/compliance-compiler
DOCKER_TAG := $(VERSION)

# Platform targets for cross-compilation
PLATFORMS := linux/amd64 darwin/amd64 darwin/arm64 windows/amd64

help: ## Display this help message
	@echo "ArdaOS Compliance Compiler Build System"
	@echo "======================================="
	@echo ""
	@echo "Available targets:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Build flags:"
	@echo "  VERSION=$(VERSION)"
	@echo "  BUILD_TIME=$(BUILD_TIME)"
	@echo "  GIT_COMMIT=$(GIT_COMMIT)"
	@echo "  GIT_BRANCH=$(GIT_BRANCH)"

# =============================================================================
# Build Targets
# =============================================================================

build: deps ## Build the compliance compiler binary
	@echo "Building compliance compiler..."
	@mkdir -p $(BUILD_DIR)
	$(GO) build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PACKAGE)
	@echo "Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

build-all: deps ## Build cross-platform binaries for all supported platforms
	@echo "Building cross-platform binaries..."
	@mkdir -p $(BUILD_DIR)
	@for platform in $(PLATFORMS); do \
		OS=$$(echo $$platform | cut -d'/' -f1); \
		ARCH=$$(echo $$platform | cut -d'/' -f2); \
		OUTPUT_NAME=$(BINARY_NAME)-$$OS-$$ARCH; \
		if [ "$$OS" = "windows" ]; then OUTPUT_NAME=$$OUTPUT_NAME.exe; fi; \
		echo "Building for $$OS/$$ARCH..."; \
		GOOS=$$OS GOARCH=$$ARCH $(GO) build $(LDFLAGS) -o $(BUILD_DIR)/$$OUTPUT_NAME $(MAIN_PACKAGE); \
	done
	@echo "Cross-platform build complete"
	@ls -la $(BUILD_DIR)/

build-release: clean deps ## Build optimized release binaries
	@echo "Building optimized release binaries..."
	@mkdir -p $(BUILD_DIR)
	@for platform in $(PLATFORMS); do \
		OS=$$(echo $$platform | cut -d'/' -f1); \
		ARCH=$$(echo $$platform | cut -d'/' -f2); \
		OUTPUT_NAME=$(BINARY_NAME)-$$OS-$$ARCH; \
		if [ "$$OS" = "windows" ]; then OUTPUT_NAME=$$OUTPUT_NAME.exe; fi; \
		echo "Building optimized binary for $$OS/$$ARCH..."; \
		CGO_ENABLED=0 GOOS=$$OS GOARCH=$$ARCH $(GO) build \
			-a -installsuffix cgo \
			-ldflags "-s -w $(LDFLAGS)" \
			-o $(BUILD_DIR)/$$OUTPUT_NAME $(MAIN_PACKAGE); \
	done
	@echo "Release build complete"

install: build ## Install the binary to $GOPATH/bin
	@echo "Installing compliance compiler to $(GOPATH)/bin..."
	$(GO) install $(LDFLAGS) $(MAIN_PACKAGE)
	@echo "Installation complete"

# =============================================================================
# Testing Targets
# =============================================================================

test: deps ## Run unit tests with coverage
	@echo "Running unit tests..."
	$(GOTEST) -v -race -coverprofile=$(COVERAGE_FILE) ./...
	@if [ -f $(COVERAGE_FILE) ]; then \
		$(GO) tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML); \
		echo "Coverage report generated: $(COVERAGE_HTML)"; \
		$(GO) tool cover -func=$(COVERAGE_FILE) | tail -1; \
	fi

test-unit: deps ## Run unit tests only (no coverage)
	@echo "Running unit tests..."
	$(GOTEST) -v ./...

test-race: deps ## Run tests with race condition detection
	@echo "Running tests with race detection..."
	$(GOTEST) -race ./...

test-coverage: deps ## Generate detailed coverage report
	@echo "Generating detailed coverage report..."
	$(GOTEST) -coverprofile=$(COVERAGE_FILE) -covermode=atomic ./...
	$(GO) tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML)
	$(GO) tool cover -func=$(COVERAGE_FILE)
	@echo "Coverage report: $(COVERAGE_HTML)"

bench: deps ## Run performance benchmarks
	@echo "Running performance benchmarks..."
	$(GOTEST) -bench=. -benchmem -run=^$$ ./internal/compiler
	$(GOTEST) -bench=. -benchmem -run=^$$ ./internal/parser
	@echo "Benchmark complete"

## test: Run all tests
test: test-unit vet lint

## test-unit: Run unit tests
test-unit:
	@echo "Running unit tests..."
	go test -v ./...

## test-race: Run tests with race condition detection
test-race:
	@echo "Running tests with race detection..."
	go test -race -v ./...

## test-cover: Run tests with coverage report
test-cover:
	@echo "Running tests with coverage..."
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

## bench: Run benchmark tests
bench:
	@echo "Running benchmark tests..."
	go test -bench=. -benchmem ./...

## lint: Run golangci-lint
lint:
	@echo "Running linter..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "golangci-lint not found. Install with: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0"; \
	fi

## fmt: Format Go code
fmt:
	@echo "Formatting Go code..."
	go fmt ./...
	@if command -v goimports >/dev/null 2>&1; then \
		goimports -w .; \
	fi

## fmt-check: Check if code is formatted
fmt-check:
	@echo "Checking code formatting..."
	@if [ -n "$$(go fmt ./...)" ]; then \
		echo "Code is not formatted. Run 'make fmt' to fix."; \
		exit 1; \
	fi
	@echo "Code is properly formatted."

## vet: Run go vet
vet:
	@echo "Running go vet..."
	go vet ./...

## deps: Download and tidy dependencies
deps:
	@echo "Downloading dependencies..."
	go mod download
	go mod tidy

## example-policies: Generate example policies
example-policies:
	@echo "Generating example policies..."
	@mkdir -p examples/generated
	$(GOBUILD)/$(BINARY_NAME) generate --type basic --output examples/generated/basic_example.yaml
	$(GOBUILD)/$(BINARY_NAME) generate --type regional --region US --output examples/generated/us_regional_example.yaml
	$(GOBUILD)/$(BINARY_NAME) generate --type asset --asset-type loan --output examples/generated/loan_asset_example.yaml

## validate-examples: Validate all example policies
validate-examples: build
	@echo "Validating example policies..."
	$(GOBUILD)/$(BINARY_NAME) validate -r examples/policies

## compile-examples: Compile all example policies
compile-examples: build
	@echo "Compiling example policies..."
	@mkdir -p examples/compiled
	@for policy in examples/policies/*.yaml; do \
		echo "Compiling $$policy..."; \
		$(GOBUILD)/$(BINARY_NAME) compile --format json --overwrite -d examples/compiled $$policy; \
	done

## test-examples: Test example policies
test-examples: build
	@echo "Testing example policies..."
	@for policy in examples/policies/*.yaml; do \
		echo "Testing $$policy..."; \
		$(GOBUILD)/$(BINARY_NAME) test -t examples/test-data/sample_transactions.json $$policy || true; \
	done

## docs: Generate documentation
docs:
	@echo "Generating documentation..."
	@mkdir -p docs/generated
	$(GOBUILD)/$(BINARY_NAME) --help > docs/generated/cli-help.txt
	$(GOBUILD)/$(BINARY_NAME) compile --help > docs/generated/compile-help.txt
	$(GOBUILD)/$(BINARY_NAME) validate --help > docs/generated/validate-help.txt
	$(GOBUILD)/$(BINARY_NAME) test --help > docs/generated/test-help.txt
	$(GOBUILD)/$(BINARY_NAME) generate --help > docs/generated/generate-help.txt
	$(GOBUILD)/$(BINARY_NAME) generate --list-types > docs/generated/template-types.txt

## dev-setup: Set up development environment
dev-setup: deps
	@echo "Setting up development environment..."
	@if ! command -v golangci-lint >/dev/null 2>&1; then \
		echo "Installing golangci-lint..."; \
		curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(shell go env GOPATH)/bin v1.61.0; \
	fi
	@if ! command -v goimports >/dev/null 2>&1; then \
		echo "Installing goimports..."; \
		go install golang.org/x/tools/cmd/goimports@latest; \
	fi

## release-build: Build binaries for multiple platforms
release-build: clean
	@echo "Building release binaries..."
	@mkdir -p $(GOBUILD)/release

	# Linux AMD64
	GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o $(GOBUILD)/release/$(BINARY_NAME)-linux-amd64 .

	# Linux ARM64
	GOOS=linux GOARCH=arm64 go build $(LDFLAGS) -o $(GOBUILD)/release/$(BINARY_NAME)-linux-arm64 .

	# macOS AMD64
	GOOS=darwin GOARCH=amd64 go build $(LDFLAGS) -o $(GOBUILD)/release/$(BINARY_NAME)-darwin-amd64 .

	# macOS ARM64
	GOOS=darwin GOARCH=arm64 go build $(LDFLAGS) -o $(GOBUILD)/release/$(BINARY_NAME)-darwin-arm64 .

	# Windows AMD64
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(GOBUILD)/release/$(BINARY_NAME)-windows-amd64.exe .

	@echo "Release binaries built in $(GOBUILD)/release/"

## docker-build: Build Docker image
docker-build:
	@echo "Building Docker image..."
	docker build -t arda-os/compliance-compiler:$(VERSION) .
	docker tag arda-os/compliance-compiler:$(VERSION) arda-os/compliance-compiler:latest

## docker-run: Run compliance-compiler in Docker
docker-run:
	docker run --rm -v $(PWD)/examples:/examples arda-os/compliance-compiler:latest --help

## integration-test: Run integration tests
integration-test: build validate-examples compile-examples
	@echo "Running integration tests..."
	@echo "✓ Build completed successfully"
	@echo "✓ Example validation completed"
	@echo "✓ Example compilation completed"
	@echo "Integration tests passed!"

## ci: Run continuous integration checks
ci: deps fmt-check vet lint test test-race
	@echo "All CI checks passed!"

## security-scan: Run security scanning
security-scan:
	@echo "Running security scan..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "gosec not found. Install with: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest"; \
	fi

## performance-test: Run performance tests
performance-test: build
	@echo "Running performance tests..."
	@mkdir -p examples/performance
	@echo "Testing compilation performance..."
	time $(GOBUILD)/$(BINARY_NAME) compile examples/policies/us_regional.yaml -o examples/performance/perf_test.pb
	@echo "Testing validation performance..."
	time $(GOBUILD)/$(BINARY_NAME) validate -r examples/policies
	@echo "Performance tests completed"

## all: Run all common development tasks
all: clean dev-setup build test lint integration-test docs
	@echo "All development tasks completed successfully!"

# Default target
.DEFAULT_GOAL := help

# Variables for tracking build info
BUILD_INFO_FILE := build_info.txt

## build-info: Display build information
build-info:
	@echo "Compliance Compiler Build Information"
	@echo "====================================="
	@echo "Binary Name: $(BINARY_NAME)"
	@echo "Version: $(VERSION)"
	@echo "Commit: $(COMMIT)"
	@echo "Build Date: $(BUILD_DATE)"
	@echo "Go Version: $(shell go version | cut -d' ' -f3-)"
	@echo "Platform: $(shell go env GOOS)/$(shell go env GOARCH)"

## version: Display version information
version: build
	$(GOBUILD)/$(BINARY_NAME) --version
